<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forest Fire Detection</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #fff3e0);
      padding: 20px;
      color: #333;
    }
    h2 {
      color: #2e7d32;
    }
    .alert {
      font-size: 20px;
      font-weight: bold;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      display: inline-block;
    }
    .safe {
      background-color: #d4edda;
      color: #155724;
    }
    .danger {
      background-color: #f8d7da;
      color: #721c24;
    }
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    table th, table td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: center;
    }
    table th {
      background-color: #eeeeee;
    }
    canvas {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      margin-top: 30px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 700px;
    }
  </style>
</head>
<body>
  <h2>ðŸŒ² Forest Fire Detection Dashboard</h2>

  <h3>ðŸ”¥ Predefined Thresholds</h3>
  <table>
    <tr>
      <th>Parameter</th>
      <th>Safe Range</th>
      <th>Fire Risk If...</th>
    </tr>
    <tr>
      <td>Methane (MQ-4)</td>
      <td>&lt; 3000</td>
      <td>&gt; 3000</td>
    </tr>
    <tr>
      <td>COâ‚‚ (MQ-135)</td>
      <td>&lt; 2500</td>
      <td>&gt; 2500</td>
    </tr>
    <tr>
      <td>Temperature (Â°C)</td>
      <td>&lt; 45</td>
      <td>&gt; 45</td>
    </tr>
  </table>

  <div id="alertBox" class="alert safe">Status: Safe</div>

  <canvas id="temperatureChart"></canvas>
  <canvas id="methaneChart"></canvas>
  <canvas id="co2Chart"></canvas>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbyNdTK-y4D7NQeCoGz_Id1rB49foyIvsVumP2mb5uPeO0MUeB8YLECWvsXyUAf3VGYm/exec";

    const METHANE_THRESHOLD = 3000;
    const CO2_THRESHOLD = 2500;
    const TEMP_THRESHOLD = 45;

    async function fetchData() {
      try {
        const response = await fetch(SHEET_URL);
        const data = await response.json();

        if (!Array.isArray(data) || data.length <= 1) {
          console.error("No data found");
          return;
        }

        const timestamps = [];
        const temperatureValues = [];
        const methaneValues = [];
        const co2Values = [];
        let latestAlert = "NO";

        for (let i = 1; i < data.length; i++) {
          timestamps.push(new Date(data[i][0]).toLocaleTimeString());
          temperatureValues.push(Number(data[i][1]));
          methaneValues.push(Number(data[i][2]));
          co2Values.push(Number(data[i][3]));
          latestAlert = data[i][4];
        }

        updateAlert(latestAlert, methaneValues.at(-1), co2Values.at(-1), temperatureValues.at(-1));

        renderChart("temperatureChart", "Temperature (Â°C)", timestamps, temperatureValues, 'red');
        renderChart("methaneChart", "Methane (MQ-4)", timestamps, methaneValues, 'orange');
        renderChart("co2Chart", "COâ‚‚ (MQ-135)", timestamps, co2Values, 'blue');

      } catch (err) {
        console.error("Fetch error: ", err);
        document.getElementById("alertBox").textContent = "Error loading data!";
        document.getElementById("alertBox").className = "alert danger";
      }
    }

    function updateAlert(alert, lastMethane, lastCO2, lastTemp) {
      const alertBox = document.getElementById("alertBox");

      let statusMsg = `âœ… Status: Safe`;
      let statusClass = "alert safe";

      if (lastMethane > METHANE_THRESHOLD || lastCO2 > CO2_THRESHOLD || lastTemp > TEMP_THRESHOLD || alert === "YES") {
        statusMsg = `ðŸ”¥ Fire Risk Detected! (Temp: ${lastTemp}Â°C, MQ-4: ${lastMethane}, MQ-135: ${lastCO2})`;
        statusClass = "alert danger";
      }

      alertBox.textContent = statusMsg;
      alertBox.className = statusClass;
    }

    function renderChart(canvasId, label, labels, data, color) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      if (window[canvasId + "_instance"]) {
        window[canvasId + "_instance"].destroy();
      }
      window[canvasId + "_instance"] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            borderColor: color,
            backgroundColor: color + '33',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    fetchData();
    setInterval(fetchData, 10000); // Refresh every 10 sec
  </script>
</body>
</html>
