<script>
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbyNdTK-y4D7NQeCoGz_Id1rB49foyIvsVumP2mb5uPeO0MUeB8YLECWvsXyUAf3VGYm/exec";

  const METHANE_THRESHOLD = 3000;
  const CO2_THRESHOLD = 2500;
  const TEMP_THRESHOLD = 45;

  async function fetchData() {
    try {
      const response = await fetch(SHEET_URL);
      const data = await response.json();

      if (!Array.isArray(data) || data.length <= 1) {
        console.error("No data found");
        return;
      }

      const timestamps = [];
      const temperatureValues = [];
      const methaneValues = [];
      const co2Values = [];
      let latestAlert = "NO";

      for (let i = 1; i < data.length; i++) {
        const row = data[i];

        const time = new Date(row[0]).toLocaleTimeString();
        const methane = parseInt(row[1]) || 0;
        const co2 = parseInt(row[2]) || 0;
        const temperature = parseFloat(row[3]) || 0;
        const alert = row[4];

        timestamps.push(time);
        methaneValues.push(methane);
        co2Values.push(co2);
        temperatureValues.push(temperature);
        latestAlert = alert;
      }

      const lastMethane = methaneValues.at(-1);
      const lastCO2 = co2Values.at(-1);
      const lastTemp = temperatureValues.at(-1);

      updateAlert(latestAlert, lastMethane, lastCO2, lastTemp);

      renderChart("temperatureChart", "Temperature (Â°C)", timestamps, temperatureValues, 'red');
      renderChart("methaneChart", "Methane (MQ-4)", timestamps, methaneValues, 'orange');
      renderChart("co2Chart", "COâ‚‚ (MQ-135)", timestamps, co2Values, 'blue');

    } catch (err) {
      console.error("Fetch error: ", err);
      const alertBox = document.getElementById("alertBox");
      alertBox.textContent = "Error loading data!";
      alertBox.className = "alert danger";
    }
  }

  function updateAlert(alert, lastMethane, lastCO2, lastTemp) {
    const alertBox = document.getElementById("alertBox");

    let statusMsg = `âœ… Status: Safe`;
    let statusClass = "alert safe";

    if (lastMethane > METHANE_THRESHOLD || lastCO2 > CO2_THRESHOLD || lastTemp > TEMP_THRESHOLD || alert === "YES") {
      statusMsg = `ðŸ”¥ Fire Risk Detected! (Temp: ${lastTemp}Â°C, MQ-4: ${lastMethane}, MQ-135: ${lastCO2})`;
      statusClass = "alert danger";
    }

    alertBox.textContent = statusMsg;
    alertBox.className = statusClass;
  }

  function renderChart(canvasId, label, labels, data, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (window[canvasId + "_instance"]) {
      window[canvasId + "_instance"].destroy();
    }
    window[canvasId + "_instance"] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          borderColor: color,
          backgroundColor: color + '33',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            suggestedMax: label.includes("Temperature") ? 100 : undefined
          }
        }
      }
    });
  }

  fetchData();
  setInterval(fetchData, 10000);
</script>
